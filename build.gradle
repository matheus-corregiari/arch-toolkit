buildscript {
    apply from: "$rootDir/tools/versions.gradle"

    repositories {
        google()
        mavenCentral()
        maven {
            url "https://plugins.gradle.org/m2/"
        }
    }

    dependencies {
        classpath "com.android.tools.build:gradle:$versions.android_plugin"
        classpath "org.jetbrains.kotlin:kotlin-gradle-plugin:$versions.kotlin"
        classpath "org.jacoco:org.jacoco.core:$versions.jacoco"
        classpath "com.getkeepsafe.dexcount:dexcount-gradle-plugin:$versions.dexcount"
        classpath "io.github.pedro-bachiega:SonatypeMavenPublishPlugin:$versions.maven_plugin"
    }
}

allprojects {
    repositories {
        google()
        mavenCentral()
    }

    afterEvaluate {
        if (!project.hasProperty("android")) return

        android {
            compileSdkVersion 33
            buildToolsVersion "32.0.0"

            defaultConfig {
                minSdkVersion 23
                targetSdkVersion 33

                versionCode 1
                versionName "1.0"

                resConfigs "en"
            }

            lintOptions {
                checkReleaseBuilds true

                abortOnError true
                ignoreWarnings false
                absolutePaths false
                warningsAsErrors false

                htmlOutput file("$rootDir/build/reports/lint/html/$name-lint.html")
                xmlOutput file("$rootDir/build/reports/lint/xml/$name-lint.xml")
            }

            aaptOptions {
                cruncherEnabled = false
            }

            testOptions {
                unitTests.includeAndroidResources true
                unitTests.returnDefaultValues = true
                animationsDisabled true
            }

            packagingOptions {
                exclude 'META-INF/LICENSE'
                pickFirst 'protobuf.meta'
                doNotStrip '*/mips/*.so'
                doNotStrip '*/mips64/*.so'
            }

            sourceSets {
                main.java.srcDirs += 'src/main/kotlin'
                test.java.srcDirs += 'src/test/kotlin'
                androidTest.java.srcDirs += 'src/androidTest/kotlin'
                androidTest.resources.srcDirs += 'src/androidTest/res'
            }

            compileOptions {
                sourceCompatibility JavaVersion.VERSION_1_8
                targetCompatibility JavaVersion.VERSION_1_8
            }

            if (project.path.contains("samples")) return

            configurations {
                javadocDeps
            }

            tasks.register('javadoc', Javadoc) {
                excludes = ['**/*.kt']
                source = android.sourceSets.main.java.srcDirs
                classpath += configurations.javadocDeps
                classpath += project.files(android.getBootClasspath().join(File.pathSeparator))
            }

            tasks.withType(Test).configureEach {
                jacoco.includeNoLocationClasses = true
                jacoco.excludes = ['jdk.internal.*']
            }

            dependencies {
                javadocDeps "com.android.support:support-annotations:$versions.android_support"
                ktlint "com.github.shyiko:ktlint:$versions.ktLint"
            }
        }
    }

    if (!project.path.contains("sample")) {
        apply from: "$rootDir/tools/dependencies/unit-test.gradle"
        apply from: "$rootDir/tools/dependencies/instrumented-test.gradle"
        apply from: "$rootDir/tools/publish/maven-publish.gradle"
    }

    apply from: "$rootDir/tools/ktlint.gradle"
    apply from: "$rootDir/tools/coverage/jacoco.gradle"
    apply from: "$rootDir/tools/coverage/jacoco-unified.gradle"
}
