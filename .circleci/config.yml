version: 2.1

executors:
  android:
    docker:
      - image: cimg/android:2023.09

commands:
  default:
    steps:
      - checkout
      - restore_cache:
          key: jars-{{ checksum "build.gradle" }}

jobs:
  dependencies:
    executor: android
    environment:
      JVM_OPTS: -Xmx2048m
    steps:
      - default
      - run:
          name: Download Dependencies
          command: ./gradlew androidDependencies
      - save_cache:
          paths:
            - ~/.gradle
          key: jars-{{ checksum "build.gradle" }}

  # Maldade Jobs
  lint:
    executor: android
    environment:
      JVM_OPTS: -Xmx2048m
    parameters:
      module:
        default: ""
        type: string
    steps:
      - default
      - run: ./gradlew :<<parameters.module>>:lint
      - run: ./gradlew :<<parameters.module>>:detekt

  test:
    executor: android
    environment:
      JVM_OPTS: -Xmx2048m
    parameters:
      module:
        default: ""
        type: string
    steps:
      - default
      - run: ./gradlew :<<parameters.module>>:createDebugCoverageReport
      - run: ./gradlew :<<parameters.module>>:koverVerify

  build:
    executor: android
    environment:
      JVM_OPTS: -Xmx2048m
    parameters:
      module:
        default: ""
        type: string
    steps:
      - default
      - run: ./gradlew :<<parameters.module>>:assembleRelease

  deploy:
    executor: android
    environment:
      JVM_OPTS: -Xmx2048m
    parameters:
      module:
        default: ""
        type: string
    steps:
      - default
      - run: ./gradlew :<<parameters.module>>:publishRelease

workflows:
  pull_request:
    jobs:
      # Builds Project and saves build cache
      - dependencies

      # Runs android lint and KtLint
      - lint:
          matrix:
            alias: lint-all-modules
            parameters:
              module:
                - toolkit:delegate
                - toolkit:event-observer
                - toolkit:foldable
                - toolkit:recycler-adapter
                - toolkit:statemachine
          name: Lint <<matrix.module>>
          requires:
            - dependencies

      # Runs Unit tests
      - test:
          matrix:
            alias: unit-test-all-modules
            parameters:
              module:
                - toolkit:delegate
                - toolkit:event-observer
                - toolkit:foldable
                - toolkit:recycler-adapter
                - toolkit:statemachine
          name: Test <<matrix.module>>
          requires:
            - Lint <<matrix.module>>

      # Build
      - build:
          matrix:
            alias: build-all-modules
            parameters:
              module:
                - toolkit:delegate
                - toolkit:event-observer
                - toolkit:foldable
                - toolkit:recycler-adapter
                - toolkit:statemachine
          name: Build <<matrix.module>>
          requires:
            - Test <<matrix.module>>

      # Ask for approval to run deploy
      - hold-deploy:
          type: approval
          requires:
            - build-all-modules
          filters:
            branches:
              only:
                - master

      # Deploys all modules
      - deploy:
          matrix:
            alias: deploy-all-modules
            parameters:
              module:
                - toolkit:delegate
                - toolkit:event-observer
                - toolkit:foldable
                - toolkit:recycler-adapter
                - toolkit:statemachine
          name: Deploy <<matrix.module>>
          requires:
            - hold-deploy
